package UDPChat.Client;

import java.io.BufferedReader;
import java.io.PrintWriter;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.InetAddress;
import java.net.DatagramSocket;
import java.net.SocketTimeoutException;
import java.net.UnknownHostException;
import java.util.Random;

import UDPChat.Shared.ChatMessage;

/**
 * 
 * @author brom
 */
public class ServerConnection
{

	// Artificial failure rate of 30% packet loss
	static double TRANSMISSION_FAILURE_RATE = 0.3;
	static int MAX_ATTEMPTS = 10;

	private String m_name = null;
	private DatagramSocket m_socket = null;
	private int m_serverPort = -1;
	private InetAddress m_serverAddress = null;

	private BufferedReader m_reader;
	private PrintWriter m_writer;

	public ServerConnection(String hostName, int port, String name)
	{
		m_name = name;

		try
		{
			m_serverPort = port;
			m_serverAddress = InetAddress.getByName(hostName);
			m_socket = new DatagramSocket(m_serverPort, m_serverAddress);
			m_writer = new PrintWriter(m_socket.getOutputStream(), true);
			m_reader = new BufferedReader(new InputStreamReader(m_socket.getInputStream()));
		} catch (UnknownHostException e)
		{
			System.err.println("Error: unknown host");
			e.printStackTrace();
		} catch (IOException e)
		{
			System.err.println("Error: IOException");
			e.printStackTrace();
			System.exit(1);
		}

	}

	public boolean connect(String name) throws IOException
	{
		// Send connection request
		ChatMessage connectionRequest = new ChatMessage(m_serverAddress, m_serverPort, 00, m_name, getTimeStamp(), "", "");

		m_writer.println(connectionRequest.getString());
		System.out.println("Sending ChatMessage: " + connectionRequest.getString());

		// Receive response
		ChatMessage received = new ChatMessage(m_reader.readLine());
		String response = received.getMessage();

		while (true)
		{
			// If a heartbeat is received before acknowledgment, simply respond
			// to it
			if (received.getCommand().equals("heartbeat"))
				heartbeat();

			if (response.equals("OK"))
			{
				// Connection approved
				System.out.println("Connection approved by server");
				return true;
			} else if (response.equals("NAME"))
			{
				// Name already taken
				System.err.println("Error: that name is already taken by another user");
				return false;
			} else
			{
				// Unknown response
				System.err.println("Error: unknown connection response: " + response);
				System.exit(1);
				return false;
			}
		}
	}

	// DISCONNECT
	public void disconnect()
	{
		ChatMessage message = new ChatMessage(m_name, "disconnect", "", "");
		System.out.println("Sending disconnect request");
		m_writer.println(message.getString());
	}

	// LIST
	public void list()
	{
		ChatMessage message = new ChatMessage(m_name, "list", "", "");
		System.out.println("Sending user list request");
		m_writer.println(message.getString());
	}

	// WHISPER
	public void whisper(String recepient, String msg)
	{
		ChatMessage message = new ChatMessage(m_name, "whisper", recepient, msg);
		System.out.println("Send whisper to " + recepient);
		m_writer.println(message.getString());
	}

	// BROADCAST
	public void broadcast(String msg)
	{
		ChatMessage message = new ChatMessage(m_name, "broadcast", "", msg);
		System.out.println("Send broadcast");
		m_writer.println(message.getString());
	}

	public void sendChatMessage(ChatMessage message)
	{
		Random generator = new Random();

		for (int i = MAX_ATTEMPTS; i > 0; i--)
		{
			double failure = generator.nextDouble();
			
			if (failure > TRANSMISSION_FAILURE_RATE)
			{

			}
			try
			{
				m_socket.setSoTimeout(1000);
				m_socket.send(message.getPacket());
			} catch (SocketTimeoutException e)
			{
				System.out.println("Socket timed out. " + i + " attempts left");
			} catch (IOException e)
			{
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			else 
			{
				System.out.println("Transmission failure. " + i + " attempts left");
			}
		}
	}

	public String receiveChatMessage()
	{
		ChatMessage chatMessage = null;
		try
		{
			System.out.println("Receiving message...");
			chatMessage = new ChatMessage(m_reader.readLine());
		} catch (IOException e)
		{
			System.err.println("Error: failed to receive message");
			e.printStackTrace();
		}

		if (chatMessage.getCommand().equals("heartbeat"))
		{
			heartbeat();
			return "";
		}

		else if (chatMessage.getCommand().equals("message"))
			return chatMessage.getMessage();

		else
		{
			System.err.println("Error: unknown message type: " + chatMessage.getCommand());
			return "";
		}
	}

	private void heartbeat()
	{
		ChatMessage message = new ChatMessage(m_name, "heartbeat", "", "");
		System.out.println("Send heartbeat");
		m_writer.println(message.getString());
	}

	private long getTimeStamp()
	{
		return System.currentTimeMillis();
	}
}
