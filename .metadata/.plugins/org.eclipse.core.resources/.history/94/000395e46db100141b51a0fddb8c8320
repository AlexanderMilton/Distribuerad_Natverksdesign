package TCPChat.Client;

import java.awt.event.*;
import java.io.IOException;

public class Client implements ActionListener
{
	static String DELIMIT = "|";
	private String m_name = null;
	private final ChatGUI m_GUI;
	private ServerConnection m_connection = null;

	public static void main(String[] args)
	{
		if (args.length < 3)
		{
			System.err.println("Usage: java Client serverhostname serverportnumber username");
			System.exit(-1);
		}

		try
		{
			Client instance = new Client(args[2]);
			instance.connectToServer(args[0], Integer.parseInt(args[1]));
		} catch (NumberFormatException e)
		{
			System.err.println("Error: port number must be an integer.");
			System.exit(-1);
		}
	}

	private Client(String userName)
	{
		m_name = userName;

		// Start up GUI (runs in its own thread)
		m_GUI = new ChatGUI(this, m_name);
	}

	private void connectToServer(String hostName, int port)
	{
		// Create a new server connection
		// TODO: Move connection to the connect command
		m_connection = new ServerConnection(hostName, port, m_name);
		try
		{
			if (m_connection.connect(m_name))
			{
				listenForServerMessages();
			} else
			{
				System.err.println("Unable to connect to server");
			}
		} catch (IOException e)
		{
			System.err.println("Error: IO exception when conencting to server");
			e.printStackTrace();
		}
	}

	private void listenForServerMessages()
	{
		do
		{
			m_GUI.displayMessage(m_connection.receiveChatMessage());
		} while (true);
	}

	// Sole ActionListener method; acts as a callback from GUI when user hits
	// enter in input field
	@Override
	public void actionPerformed(ActionEvent e)
	{
		// Since the only possible event is a carriage return in the text input
		// field,
		// the text in the chat input field can now be sent to the server.

		// Get input from GUI window
		String input = m_GUI.getInput();

		if (input.isEmpty())
			return;

		String message = new String();

		if (input.startsWith("/"))
		{
			// Input is a command
			String command = new String(input.split(" ")[0]);

			// TODO: define type token
			switch (command)
			{
			case "/connect":
			case "/c":
				String hostname = input.split(" ")[1];
				// msg = new ChatMessage(m_name, type, null, null);
				try
				{
					m_connection.connect(hostname);
				} catch (IOException e)
				{
					System.err.println("Error: IO exception when conencting to server");
					e.printStackTrace();
				}
			}
				break;

			case "/disconnect":
			case "/q":
				m_connection.disconnect();
				break;

			case "/whisper":
			case "/w":
				String recepient = input.split(" ")[1];
				message = input.split(" ", 2)[2];
				m_connection.whisper(recepient, message);
				break;

			case "/list":
			case "/l":
				m_connection.list();
				break;

			// TODO: Create extra command
			case "/emote":
			case "/e":
				message = input.split(" ")[1];
				m_connection.emote(message);
				break;

			default:
				break;
			}
		} else
		{
			// Type is broadcast
			message = input;
			m_connection.broadcast(message);

		}

		m_connection.sendChatMessage(m_GUI.getInput());
		m_GUI.clearInput();
	}
}
